{% extends 'admin_base.html' %}
{% load static %}

{% block title %}Admin Dashboard - Wajir County Health System{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border-left: 4px solid var(--primary-color);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .stat-card.success {
        border-left-color: var(--success-color);
    }

    .stat-card.warning {
        border-left-color: var(--warning-color);
    }

    .stat-card.danger {
        border-left-color: var(--danger-color);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .stat-icon.primary {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
    }

    .stat-icon.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }

    .stat-icon.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .stat-icon.danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    .stat-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .stat-change {
        font-size: 13px;
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .stat-change.positive {
        color: var(--success-color);
    }

    .stat-change.negative {
        color: var(--danger-color);
    }

    .dashboard-section {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title i {
        color: var(--primary-color);
    }

    .chart-container {
        position: relative;
        height: 350px;
        margin-top: 20px;
    }

    .alerts-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .alert-item {
        padding: 16px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 500;
    }

    .alert-item i {
        font-size: 20px;
    }

    .alert-item.danger {
        background: #fef2f2;
        color: #7f1d1d;
        border-left: 4px solid var(--danger-color);
    }

    .alert-item.warning {
        background: #fffbeb;
        color: #78350f;
        border-left: 4px solid var(--warning-color);
    }

    .alert-item.info {
        background: #eff6ff;
        color: #1e3a8a;
        border-left: 4px solid var(--primary-color);
    }

    .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .grid-2 {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 300px;
        }
    }

    .quick-action {
        padding: 12px 16px;
        background: var(--main-bg);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.3s ease;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .quick-action:hover {
        background: var(--primary-color);
        color: white;
        transform: translateX(4px);
    }

    .quick-action i {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--card-bg);
        color: var(--primary-color);
        font-size: 16px;
    }

    .quick-action:hover i {
        background: white;
        color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Health System Dashboard</h1>
    <div class="breadcrumb">
        <a href="{% url 'admin_dashboard' %}"><i class="fas fa-home"></i> Dashboard</a>
    </div>
</div>

<!-- Alerts Section -->
{% if alerts %}
<div class="alerts-container" style="margin-bottom: 30px;">
    {% for alert in alerts %}
    <div class="alert-item {{ alert.type }}">
        <i class="fas {{ alert.icon }}"></i>
        <span>{{ alert.message }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Key Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-label">Total Facilities</div>
                <div class="stat-value">{{ total_facilities }}</div>
                <div class="stat-change positive">
                    <i class="fas fa-check-circle"></i>
                    {{ operational_facilities }} operational
                </div>
            </div>
            <div class="stat-icon primary">
                <i class="fas fa-hospital"></i>
            </div>
        </div>
    </div>

    <div class="stat-card success">
        <div class="stat-header">
            <div>
                <div class="stat-label">Total Population</div>
                <div class="stat-value">{{ total_population|floatformat:0 }}</div>
                <div class="stat-change">
                    <i class="fas fa-child"></i>
                    {{ children_under_5 }} under 5 years
                </div>
            </div>
            <div class="stat-icon success">
                <i class="fas fa-users"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-label">Active Pregnancies</div>
                <div class="stat-value">{{ active_pregnancies }}</div>
                {% if high_risk_pregnancies > 0 %}
                <div class="stat-change negative">
                    <i class="fas fa-exclamation-triangle"></i>
                    {{ high_risk_pregnancies }} high risk
                </div>
                {% endif %}
            </div>
            <div class="stat-icon primary">
                <i class="fas fa-baby"></i>
            </div>
        </div>
    </div>

    <div class="stat-card success">
        <div class="stat-header">
            <div>
                <div class="stat-label">Community Health</div>
                <div class="stat-value">{{ total_chvs }}</div>
                <div class="stat-change">
                    <i class="fas fa-home"></i>
                    {{ total_community_units }} CHUs active
                </div>
            </div>
            <div class="stat-icon success">
                <i class="fas fa-user-nurse"></i>
            </div>
        </div>
    </div>

    <div class="stat-card warning">
        <div class="stat-header">
            <div>
                <div class="stat-label">Pending Referrals</div>
                <div class="stat-value">{{ pending_referrals }}</div>
                <div class="stat-change">
                    <i class="fas fa-ambulance"></i>
                    {{ emergency_referrals }} emergency
                </div>
            </div>
            <div class="stat-icon warning">
                <i class="fas fa-exchange-alt"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-label">Lab Tests (30d)</div>
                <div class="stat-value">{{ recent_lab_tests }}</div>
                <div class="stat-change positive">
                    <i class="fas fa-check"></i>
                    {{ lab_completion_rate }}% completed
                </div>
            </div>
            <div class="stat-icon primary">
                <i class="fas fa-microscope"></i>
            </div>
        </div>
    </div>

    {% if active_outbreaks > 0 %}
    <div class="stat-card danger">
        <div class="stat-header">
            <div>
                <div class="stat-label">Active Outbreaks</div>
                <div class="stat-value">{{ active_outbreaks }}</div>
                <div class="stat-change negative">
                    <i class="fas fa-exclamation-circle"></i>
                    Requires response
                </div>
            </div>
            <div class="stat-icon danger">
                <i class="fas fa-virus"></i>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-label">Active Staff</div>
                <div class="stat-value">{{ total_staff }}</div>
                <div class="stat-change">
                    <i class="fas fa-graduation-cap"></i>
                    {{ recent_trainings }} trainings (30d)
                </div>
            </div>
            <div class="stat-icon primary">
                <i class="fas fa-user-md"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="grid-2">
    <!-- Service Trends -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-chart-line"></i>
                Service Trends (6 Months)
            </div>
        </div>
        <div class="chart-container">
            <canvas id="serviceTrendsChart"></canvas>
        </div>
    </div>

    <!-- ANC Visits Trend -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-heartbeat"></i>
                ANC Visits Trend
            </div>
        </div>
        <div class="chart-container">
            <canvas id="ancTrendsChart"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="grid-2">
    <!-- Facility Distribution -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-hospital-alt"></i>
                Facility Distribution
            </div>
        </div>
        <div class="chart-container">
            <canvas id="facilityTypeChart"></canvas>
        </div>
    </div>

    <!-- Top Diseases -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-disease"></i>
                Top Diseases (90 days)
            </div>
        </div>
        <div class="chart-container">
            <canvas id="topDiseasesChart"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 3 -->
<div class="grid-2">
    <!-- Staff by Cadre -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-user-tie"></i>
                Staff Distribution by Cadre
            </div>
        </div>
        <div class="chart-container">
            <canvas id="staffCadreChart"></canvas>
        </div>
    </div>

    <!-- Deaths by Category -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-cross"></i>
                Mortality by Category (90 days)
            </div>
        </div>
        <div class="chart-container">
            <canvas id="deathsCategoryChart"></canvas>
        </div>
    </div>
</div>

<!-- Additional Statistics -->
<div class="grid-2">
    <!-- Supply Chain Status -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-boxes"></i>
                Supply Chain Status
            </div>
        </div>
        <div class="stats-grid" style="margin-top: 20px;">
            <div style="text-align: center; padding: 16px;">
                <div style="font-size: 36px; font-weight: 700; color: var(--primary-color);">{{ total_commodities }}</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Active Commodities</div>
            </div>
            <div style="text-align: center; padding: 16px;">
                <div style="font-size: 36px; font-weight: 700; color: var(--warning-color);">{{ low_stock_items }}</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Low Stock Items</div>
            </div>
            <div style="text-align: center; padding: 16px;">
                <div style="font-size: 36px; font-weight: 700; color: var(--danger-color);">{{ expired_stock }}</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Expired Items</div>
            </div>
            <div style="text-align: center; padding: 16px;">
                <div style="font-size: 36px; font-weight: 700; color: var(--primary-color);">{{ pending_procurement }}</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Pending Requests</div>
            </div>
        </div>
    </div>

    <!-- Program Status -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-project-diagram"></i>
                Programs & M&E
            </div>
        </div>
        <div class="stats-grid" style="margin-top: 20px;">
            <div style="text-align: center; padding: 16px;">
                <div style="font-size: 36px; font-weight: 700; color: var(--success-color);">{{ active_programs }}</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Active Programs</div>
            </div>
            <div style="text-align: center; padding: 16px;">
                <div style="font-size: 36px; font-weight: 700; color: var(--primary-color);">{{ ongoing_campaigns }}</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Ongoing Campaigns</div>
            </div>
            <div style="text-align: center; padding: 16px;">
                <div style="font-size: 36px; font-weight: 700; color: var(--success-color);">{{ report_submission_rate }}%</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Report Submission</div>
            </div>
            <div style="text-align: center; padding: 16px;">
                <div style="font-size: 36px; font-weight: 700; color: var(--primary-color);">{{ recent_outreach }}</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Outreach Events (30d)</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Parse data from Django
    const serviceTrends = JSON.parse('{{ service_trends|escapejs }}');
    const ancTrends = JSON.parse('{{ anc_trends|escapejs }}');
    const facilitiesByType = JSON.parse('{{ facilities_by_type|escapejs }}');
    const topDiseases = JSON.parse('{{ top_diseases|escapejs }}');
    const staffByCadre = JSON.parse('{{ staff_by_cadre|escapejs }}');
    const deathsByCategory = JSON.parse('{{ deaths_by_category|escapejs }}');

    // Chart colors
    const colors = {
        primary: '#2563EB',
        success: '#10B981',
        warning: '#F59E0B',
        danger: '#EF4444',
        purple: '#8B5CF6',
        teal: '#14B8A6',
        pink: '#EC4899',
        orange: '#F97316'
    };

    // Service Trends Chart
    new Chart(document.getElementById('serviceTrendsChart'), {
        type: 'line',
        data: {
            labels: serviceTrends.map(d => d.month),
            datasets: [
                {
                    label: 'Outpatient Visits',
                    data: serviceTrends.map(d => d.outpatient),
                    borderColor: colors.primary,
                    backgroundColor: colors.primary + '20',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Inpatient Admissions',
                    data: serviceTrends.map(d => d.inpatient),
                    borderColor: colors.warning,
                    backgroundColor: colors.warning + '20',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Deliveries',
                    data: serviceTrends.map(d => d.deliveries),
                    borderColor: colors.success,
                    backgroundColor: colors.success + '20',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // ANC Trends Chart
    new Chart(document.getElementById('ancTrendsChart'), {
        type: 'bar',
        data: {
            labels: ancTrends.map(d => d.month),
            datasets: [{
                label: 'ANC Visits',
                data: ancTrends.map(d => d.count),
                backgroundColor: colors.success,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Facility Type Chart
    new Chart(document.getElementById('facilityTypeChart'), {
        type: 'doughnut',
        data: {
            labels: facilitiesByType.map(d => d.facility_type.replace('_', ' ')),
            datasets: [{
                data: facilitiesByType.map(d => d.count),
                backgroundColor: [
                    colors.primary,
                    colors.success,
                    colors.warning,
                    colors.danger,
                    colors.purple
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });

    // Top Diseases Chart
    new Chart(document.getElementById('topDiseasesChart'), {
        type: 'bar',
        data: {
            labels: topDiseases.map(d => d.disease_name),
            datasets: [{
                label: 'Confirmed Cases',
                data: topDiseases.map(d => d.total_cases),
                backgroundColor: colors.danger,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });

    // Staff Cadre Chart
    new Chart(document.getElementById('staffCadreChart'), {
        type: 'pie',
        data: {
            labels: staffByCadre.map(d => d.cadre.replace('_', ' ')),
            datasets: [{
                data: staffByCadre.map(d => d.count),
                backgroundColor: [
                    colors.primary,
                    colors.success,
                    colors.warning,
                    colors.danger,
                    colors.purple,
                    colors.teal,
                    colors.pink,
                    colors.orange
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });

    // Deaths Category Chart
    new Chart(document.getElementById('deathsCategoryChart'), {
        type: 'bar',
        data: {
            labels: deathsByCategory.map(d => d.death_category.replace('_', ' ')),
            datasets: [{
                label: 'Deaths',
                data: deathsByCategory.map(d => d.count),
                backgroundColor: colors.danger,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endblock %}